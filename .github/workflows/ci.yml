# CI/CD Pipeline - Runs on every push and PR
# 
# What this does:
# 1. Checks out code
# 2. Sets up Java 17
# 3. Runs all unit tests
# 4. Builds Docker image (validates Dockerfile)

name: CI Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      # Step 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # Step 3: Run tests
      - name: Run tests with Maven
        working-directory: deal-api
        run: mvn test -B

      # Step 4: Upload test results
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: deal-api/target/surefire-reports/

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test  # Only runs if tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        working-directory: deal-api
        run: docker build -t deal-api:${{ github.sha }} .

  # ============================================
  # Deploy Python Lambda function to AWS
  # Only runs on push to master branch
  # ============================================
  deploy-lambda:
    name: Deploy Lambda
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Use Docker to build Linux-compatible dependencies
      - name: Package Lambda with Docker
        working-directory: deal-api/python/mean_reversion
        run: |
          # Install dependencies in Docker for Linux compatibility
          docker run --rm -v "${PWD}:/var/task" --entrypoint pip public.ecr.aws/lambda/python:3.12 \
            install -r /var/task/requirements.txt -t /var/task/package --upgrade
          # Fix permissions (Docker creates as root)
          sudo chown -R $USER:$USER package/
          # Copy Python files and create zip
          cp *.py package/
          cd package && zip -r ../lambda_deployment.zip .

      # Configure AWS credentials from GitHub Secrets
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # Deploy to Lambda via S3 (bypasses 50MB direct upload limit)
      - name: Deploy to AWS Lambda
        run: |
          # Upload to S3 first (handles large files)
          aws s3 cp deal-api/python/mean_reversion/lambda_deployment.zip \
            s3://indicator-lambda-teerth/lambda_deployment.zip
          
          # Deploy from S3
          aws lambda update-function-code \
            --function-name indicator-api \
            --s3-bucket indicator-lambda-teerth \
            --s3-key lambda_deployment.zip
          
          # Set API Key environment variable for authentication
          aws lambda update-function-configuration \
            --function-name indicator-api \
            --environment "Variables={API_KEY=${{ secrets.LAMBDA_API_KEY }}}"


